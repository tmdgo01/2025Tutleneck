import 'package:finalproject/exercise_screen.dart';
import 'package:finalproject/setting-screen.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:flutter/material.dart';
import 'package:intl/date_symbol_data_local.dart';
import 'package:table_calendar/table_calendar.dart';
import 'alarm_list_page.dart';
import 'daily_screen.dart';
import 'package:provider/provider.dart';
import 'exercise_screen.dart';
import 'dart:async';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:lottie/lottie.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await initializeDateFormatting();

  runApp(
      ChangeNotifierProvider(
        create: (context) => ExerciseLog(),
        child: MaterialApp(
          debugShowCheckedModeBanner: false,
          home: _LoadingScreen(),
        ),
      ));
}

class HomeScreen extends StatefulWidget {
  const HomeScreen({super.key});

  @override
  State<HomeScreen> createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen> {
  int dailyGoal = 3;  // Í∏∞Î≥∏Í∞í
  int weeklyGoal = 5;  // Í∏∞Î≥∏Í∞í

  String goalMessage = '';


  @override
  void initState() {
    super.initState();

    WidgetsBinding.instance.addPostFrameCallback((_) {
      _loadGoalsAndCheck();
    });

  }

  Future<void> _loadGoalsAndCheck() async {
    final prefs = await SharedPreferences.getInstance();
    int loadedDailyGoal = prefs.getInt('dailyGoal') ?? 3;
    int loadedWeeklyGoal = prefs.getInt('weeklyGoal') ?? 5;

    setState(() {
      dailyGoal = loadedDailyGoal;
      weeklyGoal = loadedWeeklyGoal;
    });

    _checkGoals();
  }

  void _checkGoals() {
    final exerciseLog = Provider.of<ExerciseLog>(context, listen: false);
    int todayCount = exerciseLog.todayCount;
    int weeklyDays = exerciseLog.weeklyExerciseDays;

    String message;

    if (todayCount >= dailyGoal && weeklyDays >= weeklyGoal) {
      message = "Ïò§ÎäòÍ≥º Ïù¥Î≤à Ï£º Î™©ÌëúÎ•º Î™®Îëê Îã¨ÏÑ±ÌñàÏñ¥Ïöî! Ï†ïÎßê Î©ãÏ†∏Ïöî! üéâ";
    } else if (todayCount >= dailyGoal) {
      message = "Ïò§Îäò Î™©ÌëúÎ•º Îã¨ÏÑ±ÌñàÏñ¥Ïöî! ÏûòÌñàÏñ¥Ïöî! üëç";
    } else if (weeklyDays >= weeklyGoal) {
      message = "Ïù¥Î≤à Ï£º Î™©ÌëúÎ•º Îã¨ÏÑ±ÌñàÏñ¥Ïöî! Î©ãÏ†∏Ïöî! üí™";
    } else {
      message = "Ïò§ÎäòÎèÑ ÌôîÏù¥ÌåÖ! Ï°∞Í∏àÎßå Îçî ÌûòÎÇ¥Ïöî! üòä";
    }

    setState(() {
      goalMessage = message;
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Color(0xFFE4F3E1),
      body: SingleChildScrollView(
        child: Column(
          children: [
            SizedBox(
              height: 80.0,  // ÏÉÅÎã®Ïó¨Î∞±
              ///Ïó¨Î∞± ÏàòÏ†ï
            ),

            Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Image.asset('asset/logo.png',
                  height: 200,
                  width: 300,
                ),
              ],
            ),

            // Î™©Ìëú Îã¨ÏÑ± Î©îÏãúÏßÄ Î∞ïÏä§ Ï∂îÍ∞Ä
            Container(
              width: 300,
              height: 60,
              margin: EdgeInsets.only(top: 20, bottom: 20),
              padding: EdgeInsets.all(12.0),
              decoration: BoxDecoration(
                color: Colors.white,
                borderRadius: BorderRadius.circular(15.0),
                border: Border.all(color: Colors.black12),
              ),
              child: Center(
                child: Text(
                  goalMessage.isEmpty
                      ? 'Î™©Ìëú Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§...'
                      : goalMessage,
                  textAlign: TextAlign.center,
                  style: TextStyle(
                    color: Colors.black87,
                    fontWeight: FontWeight.bold,
                    fontSize: 14,
                  ),
                ),
              ),
            ),

            // ÌÖçÏä§Ìä∏ Î©îÏãúÏßÄ Î∞ïÏä§ (ÌïÑÏöîÌïòÎ©¥ ÏÇ≠Ï†ú Í∞ÄÎä•)
            Container(
              width: 300,
              height: 100,
              padding: EdgeInsets.all(12.0),
              decoration: BoxDecoration(
                color: Colors.white,
                borderRadius: BorderRadius.circular(15.0),
                border: Border.all(color: Colors.black12),
              ),
              child: Text('oooÎãò, ÌòÑÏû¨ [Ïã¨Í∞Å Îã®Í≥Ñ]ÏûÖÎãàÎã§. \n Ïò§ÎäòÎèÑ ÌöåÎ≥µÏùÑ ÏúÑÌïú '
                  '\n ÏûëÏùÄ ÏõÄÏßÅÏûÑÏùÑ Ìï®Íªò Ìï¥Î¥êÏöî!',
              textAlign: TextAlign.center,
              style: TextStyle(
                color: Colors.black87,
                fontWeight: FontWeight.bold,
                ),
              ),
            ),

            SizedBox(height: 10.0),

            ///ÏÇ¨Ïù¥Ï¶à Î∞ïÏä§ ÏàòÏ†ï Ïó¨Î∞± ÏàòÏ†ï
            Padding(
              padding: EdgeInsets.symmetric(horizontal: 40.0),
              child: Column(
                children: [
                  Column(
                    mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                    children: [
                      _MenuButton(
                        icon: Icons.monitor_heart,
                        label: 'Ï∏°Ï†ï',
                        color: Color(0xFFF1F3C9),
                        onTap: (){
                          print('Ï∏°Ï†ï ÌÅ¥Î¶≠Îê®!');
                        },
                      ),
                      _MenuButton(
                        icon: Icons.calendar_month,
                        label: 'ÏùºÏßÄ',
                        color: Color(0xFFD2F0DC),
                        onTap: (){
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                              builder: (context) => DailyScreen(),
                            ),
                          );
                        },
                      ),
                    ],
                  ),

                  Column(
                    mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                    children: [
                      _MenuButton(
                        icon: Icons.fitness_center,
                        label: 'Ïö¥Îèô',
                        color: Color(0xFFF1F3C9),
                        onTap: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                              builder: (context) => ExerciseScreen(),
                            ),
                          );
                        },
                      ),
                      _MenuButton(
                        icon: Icons.access_alarms_outlined,
                        label: 'ÏïåÎûå',
                        color: Color(0xFFD2F0DC),
                        onTap: (){
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                              builder: (context) => AlarmListPage(),
                            ),
                          );
                        },
                      ),
                    ],
                  ),
                  ///ÏàòÏ†ï ÏÇ¨Ìï≠ÏûÖÎãàÎã§(Î©îÎâ¥Î≤ÑÌäº Ï∂îÍ∞Ä, Î°úÍ≥† Ïù¥Îèô), Î≤ÑÌäº ÏúÑÏπò Ï°∞Ï†ï
                  Column(
                    mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                    children: [
                      _MenuButton(
                        icon: Icons.settings,
                        label: 'ÏÑ§Ï†ï',
                        color: Color(0xFFF1F3C9),
                        onTap: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                              builder: (context) => SettingScreen(),
                            ),
                          );
                        },
                      ),
                      // Image.asset('asset/sit.png',
                      //   width: 100.0,)
                    ],
                  ),
                  ///ÏàòÏ†ïÏûÖÎãàÎã§ (ÏàòÏ†ï ÏÇ¨Ìï≠ ÎÅù)
                  ///Í±∞Î∂ÅÏù¥ ÏúÑÏπò ÌôïÏù∏!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                  // SizedBox(height: 100,),
                  //  Row(
                  //    mainAxisAlignment: MainAxisAlignment.end,
                  //    children: [
                  //      Image.asset('asset/bottom.png',
                  //        width: 80.0,)
                  //    ],

                  ////////////////////////////////////////////////////////////////////////
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }
}


///  Î©îÎâ¥ Î≤ÑÌäº
class _MenuButton extends StatelessWidget {
  final IconData icon;
  final String label;
  final Color color;
  final VoidCallback onTap;

  const _MenuButton({
    required this.icon,
    required this.label,
    required this.color,
    required this.onTap,
    super.key});

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        width: double.infinity,
        margin: EdgeInsets.symmetric(
          vertical: 8.0,
          horizontal: 20.0,
        ),
        padding: EdgeInsets.symmetric(vertical: 16.0),
        decoration: BoxDecoration(
          color: color,
          borderRadius: BorderRadius.circular(20.0),
          border: Border.all(color: Colors.black12),
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(icon,size: 30.0,),
            SizedBox(width: 12.0,),
            Text(label,
              style: TextStyle(
                  fontWeight: FontWeight.bold),
            ),
          ],
        ),
      ),
    );
  }
}

////// Î°úÎî© ÌôîÎ©¥ //////
class _LoadingScreen extends StatefulWidget {
  const _LoadingScreen({super.key});

  @override
  State<_LoadingScreen> createState() => _LoadingScreenState();
}

class _LoadingScreenState extends State<_LoadingScreen>
    with SingleTickerProviderStateMixin {
  double _opacity = 0.0;

  @override
  void initState() {
    super.initState();

    // ÌéòÏù¥Îìú Ïù∏ ÏãúÏûë
    Future.delayed(Duration(milliseconds: 200), () {
      setState(() {
        _opacity = 1.0;
      });
    });

    // 3Ï¥à Îí§ Î©îÏù∏ ÌôîÎ©¥ Ïù¥Îèô
    Timer(Duration(seconds: 3), () {
      Navigator.of(context).pushReplacement(
        MaterialPageRoute(
          builder: (_) => HomeScreen(),
        ),
      );
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.black87,
      body: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFFE4F3E1),
              Color(0xFFD2F0DC),   // ÏïÑÎûòÏ™æÏóê ÏÇ¥Ïßù Î∂âÏùÄÎπõ ÎèÑÎäî ÏÉâÏÉÅ
            ],
          ),
        ),
        child: Center(
          child: Column(
            mainAxisSize: MainAxisSize.min,
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              AnimatedOpacity(
                duration: Duration(seconds: 2),
                curve: Curves.easeInOut,
                opacity: _opacity,
                child: Container(
                  decoration: BoxDecoration(
                    shape: BoxShape.circle,
                    boxShadow: [
                      BoxShadow(
                        color: Colors.lightGreenAccent.withOpacity(0.5),  /// ÎπõÎÇòÎäî ÏÉâ
                        blurRadius: 80.0,
                        spreadRadius: 30.0,
                      ),
                    ],
                  ),
                  child: Image.asset(
                    'asset/1.png',
                    width: 200,
                    height: 200,
                  ),
                ),
              ),

              SizedBox(height: 12.0),
              /// ÌïòÎã® ÌÖçÏä§Ìä∏
              Padding(
                padding: EdgeInsets.only(bottom: 40.0),
                child: Text(
                  'Turtle neck',
                  style: TextStyle(
                    color: Colors.black.withOpacity(0.5), // Î∞òÌà¨Î™Ö Ìù∞ÏÉâ
                    fontSize: 20.0,
                    fontWeight: FontWeight.w500,
                    letterSpacing: 2,
                  ),
                ),
              ),
            ],
          ),
        ),
      ),

    );
  }
}
// class _SplashPage extends StatefulWidget {
//   const _SplashPage({super.key});
//
//   @override
//   State<_SplashPage> createState() => _SplashPageState();
// }
//
// class _SplashPageState extends State<_SplashPage> {
//   @override
//   void initState() {
//     super.initState();
//     Timer(const Duration(seconds: 3), () {
//       Navigator.pushReplacement(
//         context,
//         MaterialPageRoute(builder: (_) => HomeScreen()),
//       );
//     });
//   }
//
//   @override
//   Widget build(BuildContext context) {
//     return Scaffold(
//       backgroundColor: Color(0xFFFFDF8E8),
//       body: Center(
//         child: Lottie.asset(
//           'assets/dh.json',  // GIFÎ•º Î≥ÄÌôòÌïú Lottie ÌååÏùº
//           width:300,
//           height: 300,
//           fit: BoxFit.contain,
//         ),
//       ),
//     );
//   }
// }